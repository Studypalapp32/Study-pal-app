{% extends "base.html" %}

{% block title %}Quiz - Study Pal{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Quiz Header -->
        <div class="text-center mb-4">
            <h2 class="text-primary mb-2">
                <i class="bi bi-clipboard-check me-2"></i>
                Study Pal Quiz
            </h2>
            <p class="text-muted">
                Answer all {{ questions|length }} questions below. You can change your answers before submitting.
            </p>
        </div>

        <!-- Progress Bar -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-semibold">Progress</span>
                    <span id="progressText">0 of {{ questions|length }} answered</span>
                </div>
                <div class="progress" style="height: 10px;">
                    <div class="progress-bar bg-success" 
                         role="progressbar" 
                         id="progressBar"
                         style="width: 0%" 
                         aria-valuenow="0" 
                         aria-valuemin="0" 
                         aria-valuemax="{{ questions|length }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Form -->
        <form action="{{ url_for('submit_quiz') }}" method="post" id="quizForm">
            {% for question in questions %}
            <div class="card shadow-sm border-0 mb-4 question-card" id="question-{{ question.id }}">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <span class="badge bg-primary me-2">{{ loop.index }}</span>
                        {{ question.question }}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for option in ['A', 'B', 'C', 'D'] %}
                        <div class="col-md-6 mb-3">
                            <div class="form-check option-check">
                                <input class="form-check-input question-input" 
                                       type="radio" 
                                       name="q{{ question.id }}" 
                                       id="q{{ question.id }}_{{ option }}" 
                                       value="{{ option }}"
                                       data-question="{{ question.id }}"
                                       aria-describedby="q{{ question.id }}_label">
                                <label class="form-check-label w-100" 
                                       for="q{{ question.id }}_{{ option }}"
                                       id="q{{ question.id }}_label">
                                    <span class="option-letter fw-bold text-primary me-2">{{ option }}.</span>
                                    <span class="option-text">{{ question[option] }}</span>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Submit Section -->
            <div class="card shadow-sm border-0 mb-5">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-info-circle text-info me-2"></i>
                        <span class="text-muted">Review your answers before submitting. Unanswered questions will be marked as incorrect.</span>
                    </div>
                    
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        <button type="button" 
                                class="btn btn-outline-secondary btn-lg" 
                                onclick="scrollToFirstUnanswered()">
                            <i class="bi bi-search me-2"></i>
                            Check Unanswered
                        </button>
                        
                        <button type="submit" 
                                class="btn btn-success btn-lg px-5" 
                                id="submitBtn">
                            <i class="bi bi-check-circle me-2"></i>
                            Submit Quiz
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-question-circle text-warning me-2"></i>
                    Confirm Submission
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Once submitted, you cannot change your answers.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-arrow-left me-2"></i>
                    Go Back
                </button>
                <button type="button" class="btn btn-success" id="confirmSubmit">
                    <i class="bi bi-check-circle me-2"></i>
                    Submit Quiz
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let totalQuestions = parseInt('{{ questions|length }}');
    let answeredQuestions = 0;
    
    // Update progress when answers change
    function updateProgress() {
        answeredQuestions = document.querySelectorAll('input[type="radio"]:checked').length;
        let percentage = (answeredQuestions / totalQuestions) * 100;
        
        document.getElementById('progressBar').style.width = percentage + '%';
        document.getElementById('progressBar').setAttribute('aria-valuenow', answeredQuestions);
        document.getElementById('progressText').textContent = answeredQuestions + ' of ' + totalQuestions + ' answered';
        
        // Update progress bar color
        let progressBar = document.getElementById('progressBar');
        if (percentage === 100) {
            progressBar.className = 'progress-bar bg-success';
        } else if (percentage >= 50) {
            progressBar.className = 'progress-bar bg-warning';
        } else {
            progressBar.className = 'progress-bar bg-danger';
        }
    }
    
    // Add event listeners to all radio buttons
    document.querySelectorAll('.question-input').forEach(input => {
        input.addEventListener('change', updateProgress);
    });
    
    // Scroll to first unanswered question
    function scrollToFirstUnanswered() {
        let questionNumbers = Array.from({length: totalQuestions}, (_, i) => i + 1);
        
        for (let qNum of questionNumbers) {
            let answered = document.querySelector(`input[name="q${qNum}"]:checked`);
            if (!answered) {
                let questionCard = document.getElementById(`question-${qNum}`);
                questionCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Highlight the question temporarily
                questionCard.classList.add('border-warning');
                setTimeout(() => {
                    questionCard.classList.remove('border-warning');
                }, 2000);
                
                return;
            }
        }
        
        // All questions answered
        alert('All questions have been answered! You can submit the quiz now.');
    }
    
    // Form submission with confirmation
    document.getElementById('quizForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        let unansweredCount = totalQuestions - answeredQuestions;
        let message;
        
        if (unansweredCount === 0) {
            message = `You have answered all ${totalQuestions} questions. Ready to submit?`;
        } else {
            message = `You have ${unansweredCount} unanswered question${unansweredCount > 1 ? 's' : ''}. These will be marked as incorrect. Do you want to submit anyway?`;
        }
        
        document.getElementById('confirmMessage').textContent = message;
        
        // Show confirmation modal
        let modal = new bootstrap.Modal(document.getElementById('confirmModal'));
        modal.show();
    });
    
    // Confirm submission
    document.getElementById('confirmSubmit').addEventListener('click', function() {
        // Show loading state
        let submitBtn = document.getElementById('submitBtn');
        let originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
        submitBtn.disabled = true;
        
        // Submit the form
        document.getElementById('quizForm').submit();
    });
    
    // Auto-save answers to localStorage
    function saveAnswers() {
        let answers = {};
        document.querySelectorAll('input[type="radio"]:checked').forEach(input => {
            answers[input.name] = input.value;
        });
        localStorage.setItem('quizAnswers', JSON.stringify(answers));
    }
    
    // Restore answers from localStorage
    function restoreAnswers() {
        let saved = localStorage.getItem('quizAnswers');
        if (saved) {
            let answers = JSON.parse(saved);
            for (let [name, value] of Object.entries(answers)) {
                let input = document.querySelector(`input[name="${name}"][value="${value}"]`);
                if (input) {
                    input.checked = true;
                }
            }
            updateProgress();
        }
    }
    
    // Save answers when they change
    document.querySelectorAll('.question-input').forEach(input => {
        input.addEventListener('change', saveAnswers);
    });
    
    // Clear saved answers when form is submitted
    document.getElementById('quizForm').addEventListener('submit', function() {
        localStorage.removeItem('quizAnswers');
    });
    
    // Initialize
    restoreAnswers();
    updateProgress();
    
    // Prevent accidental page reload
    window.addEventListener('beforeunload', function(e) {
        if (answeredQuestions > 0) {
            e.preventDefault();
            e.returnValue = '';
        }
    });
</script>
{% endblock %} 